name: build 
on:
  push:
    branches: [master, rootless]
    
permissions:
  actions: read
  contents: write  # To upload artifacts (required for actions/upload-artifact)
  
jobs:
  build:
    name: Build App
    runs-on: macOS-latest
    env:
      THEOS: theos

    steps:
    - name: Setup log capture
      run: |
        # This will help capture logs throughout the build
        echo "Build started at: $(date)" > build_log.txt
        echo "GITHUB_RUN_ID: $GITHUB_RUN_ID" >> build_log.txt

    - name: Checkout
      uses: actions/checkout@master
      
    - name: Install Dependencies
      run: |
        brew install ldid xz make  # ← Added 'make' here
        
    - name: Install Modern GNU Make
      run: |
        # Install the latest GNU Make
        brew install make
        # Add GNU Make to PATH (takes precedence over system make)
        echo "$(brew --prefix make)/libexec/gnubin" >> $GITHUB_PATH
        
    - name: Set up Theos
      run: |
        export THEOS=~/theos
        [ -d "$THEOS" ] && (cd "$THEOS" && git pull --recurse-submodules) || git clone --recursive https://github.com/theos/theos.git "$THEOS"
        echo "THEOS=$THEOS" >> $GITHUB_ENV
        echo "$THEOS/bin" >> $GITHUB_PATH

    - name: Cache OpenCV
      uses: actions/cache@v3
      id: opencv-cache
      with:
        path: frameworks/opencv2.framework
        key: ${{ runner.os }}-opencv-${{ hashFiles('build.yml') }}
        restore-keys: |
          ${{ runner.os }}-opencv-

    - name: Checkout OpenCV (if not cached)
      if: steps.opencv-cache.outputs.cache-hit != 'true'
      run: |
        git clone --branch 4.x --depth 1 https://github.com/opencv/opencv.git opencv-repo
        
    - name: Build OpenCV Framework (if not cached)
      if: steps.opencv-cache.outputs.cache-hit != 'true'
      run: |
        cd opencv-repo
        python3 platforms/ios/build_framework.py ios \
          --iphoneos_archs "arm64,arm64e" \
          --iphoneos_deployment_target "15.0" \
          --disable-bitcode \
          --static \
          --build_only_specified_archs \
          --legacy_build
        mkdir -p ../frameworks
        cp -R ios/opencv2.framework ../frameworks/
       
    - name: Install Theos Headers
      run: |
        git clone --depth=1 https://github.com/theos/headers.git /tmp/theos-headers
        mkdir -p ~/theos/vendor/include
        cp -R /tmp/theos-headers/* ~/theos/vendor/include/
        
    - name: Download iOS 16.1 SDK (Rootless Compatible)
      run: |
        # Create the sdks directory if it doesn't exist
        mkdir -p ~/theos/sdks
        curl -L -o ios-sdk.zip "https://github.com/xybp888/iOS-SDKs/releases/download/iOS-SDKs/iPhoneOS16.1.sdk.zip"
        unzip ios-sdk.zip -d ~/theos/sdks/
        rm -rf ios-sdk.zip
        
    - name: Set Rootless Build Environment
      run: |
        echo "THEOS_PACKAGE_SCHEME=rootless" >> $GITHUB_ENV
        
    - name: Use Substrate compatibility
      run: |
        # Disable libhooker and ellekit to use default Substrate
        echo "THEOS_USE_LIBHOOKER=0" >> $GITHUB_ENV
        echo "TWEAK_USE_ELLEKIT=0" >> $GITHUB_ENV
    
    - name: Build Package
      id: build_package
      run: |
        make package FINALPACKAGE=1
        echo "package=$(ls -t packages/*.deb | head -n1 | xargs basename)" >> $GITHUB_OUTPUT

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: build-${{ github.run_number }}
        release_name: Build ${{ github.run_number }}
        draft: false
        prerelease: false
                            
    - name: Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}          
        asset_path: ./packages/${{ steps.build_package.outputs.package }}
        asset_name: ${{ steps.build_package.outputs.package }}
        asset_content_type: application/vnd.debian.binary-package
        
    - name: Capture final build logs
      if: always()
      run: |
        echo "Build completed at: $(date)" >> build_log.txt
        echo "Final result: ${{ job.status }}" >> build_log.txt
        
        # Capture recent console output (last 100 lines might be available)
        history 100 2>/dev/null >> build_log.txt || echo "History unavailable" >> build_log.txt

    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: build-logs
        path: build_log.txt
        retention-days: 1
  # LOG PROCESSING JOB - RUNS NO MATTER WHAT
  process-logs:
    name: Process Build Logs
    needs: [build]  # Runs after build job, even if it fails
    if: always()  # This ensures it runs no matter what
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download build logs
        uses: actions/download-artifact@v3
        with:
          name: build-logs  # We'll need to capture logs in the build job first
          path: ./logs

      - name: Process and filter log
        run: |
          echo "## LOG PROCESSING ##"
          echo "Build conclusion: ${{ needs.build.result }}"
          
          # Check if log files exist
          if [ -f "logs/raw_log.txt" ]; then
            echo "Found raw log file"
            cp logs/raw_log.txt .
          else
            echo "No raw log found, creating placeholder"
            echo "Build log unavailable - job status: ${{ needs.build.result }}" > raw_log.txt
          fi
          
          # Filter for important information
          grep -E -i \
            "##\[(warning|error)\]|Error:|error:|FAIL|FAILED|Exception|fatal:|##\[group\]|##\[endgroup\]|==>|🍺|Cache|Switched|Initialized|Cloning|Downloading|curl|unzip|make:|ldid:|brew install|THEOS|SDK|framework" \
            raw_log.txt > filtered_log.txt || echo "No matches found" > filtered_log.txt
          
          # Add header and summary
          echo "## STRIPPED BUILD LOG ##" > stripped_log.txt
          echo "Workflow: ${{ github.workflow }}" >> stripped_log.txt
          echo "Run ID: ${{ github.run_id }}" >> stripped_log.txt
          echo "Run Number: ${{ github.run_number }}" >> stripped_log.txt
          echo "Status: ${{ needs.build.result }}" >> stripped_log.txt
          echo "Branch: ${{ github.ref_name }}" >> stripped_log.txt
          echo "Commit: ${{ github.sha }}" >> stripped_log.txt
          echo "Triggered by: ${{ github.event_name }}" >> stripped_log.txt
          echo "=========================" >> stripped_log.txt
          cat filtered_log.txt >> stripped_log.txt
          
          # Add final result
          echo "" >> stripped_log.txt
          echo "## FINAL RESULT ##" >> stripped_log.txt
          tail -20 raw_log.txt >> stripped_log.txt 2>/dev/null || echo "No tail available" >> stripped_log.txt

      - name: Upload processed log
        uses: actions/upload-artifact@v3
        with:
          name: processed-build-log-${{ github.run_number }}
          path: stripped_log.txt
          retention-days: 7

      - name: Upload raw log for debugging
        uses: actions/upload-artifact@v3
        with:
          name: raw-build-log-${{ github.run_number }}
          path: raw_log.txt
          retention-days: 7