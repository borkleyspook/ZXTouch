#!/bin/sh
# Detect rootless environment dynamically
if [ -d "/var/jb" ]; then
    PATH_PREFIX="/var/jb"
    TYPE_PREFIX="less"
    echo "Rootless environment detected"
else
    PATH_PREFIX=""
    TYPE_PREFIX="full"
    echo "Traditional rootful environment"
fi

# Use dynamic paths
ZXTOUCH_PATH="${PATH_PREFIX}/var/mobile/Library/ZXTouch"
BIN_PATH="${PATH_PREFIX}/usr/bin"
APPLICATIONS_PATH="${PATH_PREFIX}/Applications"
SUBSTRATE_PATH="${PATH_PREFIX}/Library/MobileSubstrate/DynamicLibraries"

echo "Signing ZXTouch binaries..."
# Add existence checks before signing
if [ -f "${BIN_PATH}/zxtouchb" ]; then
    ldid -S "${BIN_PATH}/zxtouchb"
    echo "✅ Signed zxtouchb"
fi

if [ -f "${APPLICATIONS_PATH}/zxtouch.app/zxtouch" ]; then
    ldid -S "${APPLICATIONS_PATH}/zxtouch.app/zxtouch"
    echo "✅ Signed zxtouch.app binary"
fi

if [ -f "${SUBSTRATE_PATH}/appdelegate.dylib" ]; then
    ldid -S "${SUBSTRATE_PATH}/appdelegate.dylib"
    echo "✅ Signed appdelegate.dylib"
fi

if [ -f "${SUBSTRATE_PATH}/pccontrol.dylib" ]; then
    ldid -S "${SUBSTRATE_PATH}/pccontrol.dylib"
    echo "✅ Signed pccontrol.dylib"
fi

echo "✅ Code signing completed"

"${BIN_PATH}/uicache"

# Handle ZXTouch directory
if [ -d "$ZXTOUCH_PATH" ]; then
    echo "Setting permissions for: $ZXTOUCH_PATH"
    chown -R mobile:mobile "$ZXTOUCH_PATH" 2>/dev/null || echo "⚠️ Could not change ownership (may be normal in rootless)"
    chmod -R 755 "$ZXTOUCH_PATH"
else
    echo "Creating directory: $ZXTOUCH_PATH"
    mkdir -p "$ZXTOUCH_PATH"
    chown -R mobile:mobile "$ZXTOUCH_PATH" 2>/dev/null || echo "⚠️ Could not change ownership (may be normal in rootless)"
    chmod -R 755 "$ZXTOUCH_PATH"
fi

# Make add_datetime.sh executable
if [ -f "${ZXTOUCH_PATH}/coreutils/ScriptRuntime/add_datetime.sh" ]; then
    chmod +x "${ZXTOUCH_PATH}/coreutils/ScriptRuntime/add_datetime.sh"
    echo "✅ Made add_datetime.sh executable"
else
    echo "⚠️ add_datetime.sh not found at ${ZXTOUCH_PATH}/coreutils/ScriptRuntime/add_datetime.sh"
fi

echo "Installation completed successfully for root${TYPE_PREFIX} environment"