#!/bin/bash
# Rootless postinst script
# Add these lines to your existing postinst script
echo "Signing ZXTouch binaries for rootless..."
ldid -S /var/jb/usr/bin/zxtouchb
ldid -S /var/jb/Library/MobileSubstrate/DynamicLibraries/appdelegate.dylib
ldid -S /var/jb/Library/MobileSubstrate/DynamicLibraries/pccontrol.dylib
echo "âœ… Code signing completed"

# UICache - use proper rootless-compatible method
if [ -f /usr/bin/uicache ]; then
    /usr/bin/uicache
elif [ -f /var/jb/usr/bin/uicache ]; then
    /var/jb/usr/bin/uicache
fi

# Remove sudoers entry - not needed in rootless
# sudo doesn't exist in rootless environments

# Set permissions for ZXTouch directory
ZXTOUCH_PATH="/var/mobile/Library/ZXTouch"
if [ -d "$ZXTOUCH_PATH" ]; then
    # Use chmod instead of chown (ownership changes restricted in rootless)
    chmod -R 755 "$ZXTOUCH_PATH"
    
    # For rootless, the mobile user should already have appropriate access
    # without needing ownership changes
fi

# Make add_datetime.sh executable
if [ -f "/var/mobile/Library/ZXTouch/coreutils/ScriptRuntime/add_datetime.sh" ]; then
    chmod +x "/var/mobile/Library/ZXTouch/coreutils/ScriptRuntime/add_datetime.sh"
fi

# Additional rootless considerations
# Check if we're in a rootless environment
if [ -d "/var/jb" ]; then
    echo "Rootless environment detected"
    
    # Ensure proper paths exist
    if [ ! -d "/var/mobile/Library/ZXTouch" ]; then
        mkdir -p "/var/mobile/Library/ZXTouch"
        chmod 755 "/var/mobile/Library/ZXTouch"
    fi
fi

echo "Installation completed for rootless jailbreak"